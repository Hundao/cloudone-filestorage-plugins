# Cloud One File Storage Security Post Scan Action - Publish Malware to SNS Topic

After a scan occurs, this example Lambda function publish the malware information to specific SNS topic.

## Prerequisites

### Find the 'ScanResultTopicARN' SNS topic ARN

- In the AWS console, go to **Services > CloudFormation** > your all-in-one stack > **Outputs**  or **Services > CloudFormation** > your storage stack > **Outputs**.
- Scroll down to locate the **ScanResultTopicARN** Key.
- Copy the **ScanResultTopic** ARN to a temporary location. Example: `arn:aws:sns:us-east-1:123445678901:FileStorageSecurity-All-In-One-Stack-StorageStack-1IDPU1PZ2W5RN-ScanResultTopic-N8DD2JH1GRKF`

## Installation

### From SAM CLI

```bash
sam deploy \
--stack-name <YOUR_STACK_NAME> \
--capabilities CAPABILITY_AUTO_EXPAND CAPABILITY_NAMED_IAM \
--region <YOUR_REGION> \
--s3-bucket <YOUR_S3_BUCKET> \
--template-file template.yml \
--parameter-overrides \
ParameterKey=TargetSnsTopicArn,ParameterValue=<YOUR_TARGET_TOPIC_ARN> \
ParameterKey=ScanResultTopicARN,ParameterValue=<SCAN_RESULT_TOPIC_ARN>
```

- where:
  - `<YOUR_STACK_NAME>` is the stack name for this plugin.
  - `<YOUR_REGION>` is the building AWS region.
  - `<YOUR_S3_BUCKET>` is the template put in.
  - `<YOUR_TARGET_TOPIC_ARN>` is the malware information published.
  - `<SCAN_RESULT_TOPIC_ARN>` is the SNS topic ARN from the storage stack.

### From Makefile

In a shell program, enter the following GNU Make command, using backslashes (`\`) to separate lines

1. **Create Malware Target SNS Topic**

    ```bash
    TARGET_SNS_TOPIC_NAME=<YOUR_TARGET_SNS_TOPIC_NAME> \
    make create-target-sns-topic
    ```

- where:
  - `<YOUR_TARGET_SNS_TOPIC_NAME>` is the name for the new SNS topic which cloud be published the walmare information.

2. **Create Required Policy**

    ```bash
    PUBLISH_MALWARE_POLICY_NAME=<YOUR_PUBLISH_MALWARE_POLICY_NAME> \
    make create-publish-malware-policy
    ```

- where
  - `<YOUR_PUBLISH_MALWARE_POLICY_NAME>` is the name for the new policy.

3. **Create Required Role**

    ```bash
    PUBLISH_MALWARE_POLICY_NAME=<YOUR_PUBLISH_MALWARE_ROLE_NAME> \
    make create-publish-malware-role
    ```

- where
  - `<YOUR_PUBLISH_MALWARE_ROLE_NAME>` is the name for the new role.

4. **Attach Policy**

    ```bash
    PUBLISH_MALWARE_ROLE_NAME=<YOUR_PUBLISH_MALWARE_ROLE_NAME> \
    PUBLISH_MALWARE_POLICY_ARN=<YOUR_PUBLISH_MALWARE_POLICY_ARN> \
    make create-publish-malware-role
    ```

- where
  - `<YOUR_PUBLISH_MALWARE_POLICY_ARN>` is the policy ARN created from step 2.
  - `<YOUR_PUBLISH_MALWARE_ROLE_NAME>` is the role name created from step 3.

5. **Create Lambda Function**

    ```bash
    PUBLISH_MALWARE_LAMBDA_NAME=<YOUR_PUBLISH_MALWARE_LAMBDA_NAME> \
    PUBLISH_MALWARE_ROLE_ARN=<YOUR_PUBLISH_MALWARE_ROLE_ARN> \
    TARGET_SNS_TOPIC_ARN=<YOUR_TARGET_SNS_TOPIC_ARN> \
    make create-function
    ```

- where
  - `<YOUR_TARGET_SNS_TOPIC_ARN>` is the SNS topic ARN created from step 1.
  - `<YOUR_PUBLISH_MALWARE_ROLE_ARN>` is the role ARN created from step 3.
  - `<YOUR_PUBLISH_MALWARE_LAMBDA_NAME>` is the name for new lambda function.

6. **SNS Subscrition**

    ```bash
    SCAN_RESULT_TOPIC_ARN=<YOUR_SCAN_RESULT_TOPIC_ARN> \
    PUBLISH_MALWARE_LAMBDA_ARN=<YOUR_PUBLISH_MALWARE_LAMBDA_ARN> \
    REGION=<YOUR_REGION> \
    make subscribe-to-sns-topic
    ```

- where
  - `<YOUR_PUBLISH_MALWARE_LAMBDA_ARN>` is the lambda function ARN created from step 5.
  - `<YOUR_SCAN_RESULT_TOPIC_ARN>` is the SNS topic ARN from the storage stack.
  - `<YOUR_REGION>` is the building AWS region.

7. **Add Lambda Permission**

    ```bash
    PUBLISH_MALWARE_LAMBDA_NAME=<YOUR_PUBLISH_MALWARE_LAMBDA_NAME> \
    REGION=<YOUR_REGION> \
    SCAN_RESULT_TOPIC_ARN=<YOUR_SCAN_RESULT_TOPIC_ARN> \
    make add-lambda-permission
    ```

- where
  - `<YOUR_PUBLISH_MALWARE_LAMBDA_NAME>` is the lambda function and created from step 5.
  - `<YOUR_REGION>` is the building AWS region.
  - `<SCAN_RESULT_TOPIC_ARN>` is the SNS topic ARN from the storage stack.
